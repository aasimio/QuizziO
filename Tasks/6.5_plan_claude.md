# Task 6.5 Error Handling - Implementation Plan

## Objective
Improve error handling in the scanning flow to show user-friendly messages with appropriate actions for each error type.

---

## 1. Audit Findings (6.5.1)

### Current ScannerErrorType Usage

| Error Type | Defined | Used in Bloc | UI Title | UI Action |
|------------|---------|--------------|----------|-----------|
| `cameraPermission` | Yes | **No** | Not handled | N/A |
| `cameraUnavailable` | Yes | **No** | Not handled | N/A |
| `cameraInitialization` | Yes | Yes (catch-all) | "Camera Error" | Retry |
| `markerDetection` | Yes | Yes | "Markers Not Found" | Retry |
| `imageCapture` | Yes | Yes | "Capture Failed" | Retry |
| `omrProcessing` | Yes | Yes | "Processing Error" | Retry |
| `grading` | Yes | **No** (inline) | "Grading Error" | Retry |
| `persistence` | Yes | Yes | "Save Error" | Retry |
| `unknown` | Yes | **No** | Not handled | N/A |

### Gaps Identified

1. **No permission detection**: `CameraService.initialize()` doesn't check camera permission before attempting initialization. Permission denied errors surface as generic `CameraException` with no way to distinguish them.

2. **No "Open Settings" action**: When permission is denied, user should be able to open app settings to grant permission.

3. **No "Close" action for unavailable camera**: When camera hardware is unavailable, retry is pointless - user should close the scanner.

4. **Generic error messages**: Current messages include technical details (exception toString), not user-friendly guidance.

5. **Missing `_getErrorTitle()` cases**: Switch statement doesn't handle `cameraPermission`, `cameraUnavailable`, or `unknown`.

---

## 2. Implementation Plan

### 2.1 Add Permission Check to CameraService (6.5.2)

**File:** `lib/core/services/camera_service.dart`

**Changes:**
1. Import `permission_handler` package
2. Add permission check before camera initialization
3. Throw typed exceptions for permission denied vs camera unavailable

```dart
import 'package:permission_handler/permission_handler.dart';

/// Custom exception for camera permission denied
class CameraPermissionDeniedException implements Exception {
  final bool permanentlyDenied;
  const CameraPermissionDeniedException({this.permanentlyDenied = false});

  @override
  String toString() => permanentlyDenied
    ? 'Camera permission permanently denied'
    : 'Camera permission denied';
}

/// Custom exception for camera not available
class CameraUnavailableException implements Exception {
  const CameraUnavailableException();

  @override
  String toString() => 'No camera available on this device';
}

// In initialize():
Future<void> initialize() async {
  _profiler.startTimer(MetricType.coldStartCameraInit);
  try {
    // Step 1: Check camera permission
    final status = await Permission.camera.status;

    if (status.isDenied) {
      // Request permission
      final result = await Permission.camera.request();
      if (result.isDenied) {
        throw const CameraPermissionDeniedException(permanentlyDenied: false);
      }
      if (result.isPermanentlyDenied) {
        throw const CameraPermissionDeniedException(permanentlyDenied: true);
      }
    } else if (status.isPermanentlyDenied) {
      throw const CameraPermissionDeniedException(permanentlyDenied: true);
    }

    // Step 2: Get available cameras
    _cameras = await availableCameras();

    if (_cameras.isEmpty) {
      throw const CameraUnavailableException();
    }

    // ... rest of initialization
  } catch (e) {
    // Re-throw typed exceptions, wrap others
    if (e is CameraPermissionDeniedException || e is CameraUnavailableException) {
      rethrow;
    }
    throw CameraException('initializationFailed', 'Failed to initialize camera: $e');
  } finally {
    _profiler.stopTimer(MetricType.coldStartCameraInit);
  }
}
```

### 2.2 Update ScannerBloc Error Detection (6.5.2, 6.5.3)

**File:** `lib/features/omr/presentation/bloc/scanner_bloc.dart`

**Changes:**
Update `_onInitCamera()` to detect permission and availability errors:

```dart
Future<void> _onInitCamera(
  ScannerInitCamera event,
  Emitter<ScannerState> emit,
) async {
  emit(const ScannerInitializing());

  try {
    _currentQuiz = event.quiz;
    await _cameraService.initialize();
    // ... rest of initialization
  } on CameraPermissionDeniedException catch (e) {
    if (isClosed) return;
    add(ScannerErrorOccurred(
      message: e.permanentlyDenied
        ? 'Camera access was denied. Please enable it in Settings to scan papers.'
        : 'Camera access is required to scan papers.',
      type: ScannerErrorType.cameraPermission,
    ));
  } on CameraUnavailableException {
    if (isClosed) return;
    add(const ScannerErrorOccurred(
      message: 'No camera found on this device.',
      type: ScannerErrorType.cameraUnavailable,
    ));
  } catch (e) {
    if (isClosed) return;
    add(ScannerErrorOccurred(
      message: 'Could not start camera. Please try again.',
      type: ScannerErrorType.cameraInitialization,
    ));
  }
}
```

### 2.3 Update ScannerState with Permission Flag (6.5.2)

**File:** `lib/features/omr/presentation/bloc/scanner_state.dart`

**Changes:**
Add `isPermanentlyDenied` flag to `ScannerError` for permission errors:

```dart
class ScannerError extends ScannerState {
  final String message;
  final ScannerErrorType type;

  /// Whether permission was permanently denied (for cameraPermission type)
  final bool isPermanentlyDenied;

  const ScannerError({
    required this.message,
    required this.type,
    this.isPermanentlyDenied = false,
  });

  @override
  List<Object?> get props => [message, type, isPermanentlyDenied];
}
```

Also update `ScannerErrorOccurred` event:

```dart
class ScannerErrorOccurred extends ScannerEvent {
  final String message;
  final ScannerErrorType type;
  final bool isPermanentlyDenied;

  const ScannerErrorOccurred({
    required this.message,
    required this.type,
    this.isPermanentlyDenied = false,
  });

  @override
  List<Object?> get props => [message, type, isPermanentlyDenied];
}
```

### 2.4 Update Error UI in ScanPapersPage (6.5.2 - 6.5.6)

**File:** `lib/features/omr/presentation/pages/scan_papers_page.dart`

**Changes:**

1. Import `permission_handler`:
```dart
import 'package:permission_handler/permission_handler.dart';
```

2. Update `_getErrorTitle()` to handle all types:
```dart
String _getErrorTitle(ScannerErrorType type) {
  return switch (type) {
    ScannerErrorType.cameraPermission => 'Camera Access Required',
    ScannerErrorType.cameraUnavailable => 'Camera Not Available',
    ScannerErrorType.cameraInitialization => 'Camera Error',
    ScannerErrorType.markerDetection => 'Sheet Not Detected',
    ScannerErrorType.imageCapture => 'Capture Failed',
    ScannerErrorType.omrProcessing => 'Processing Error',
    ScannerErrorType.grading => 'Grading Error',
    ScannerErrorType.persistence => 'Save Error',
    ScannerErrorType.unknown => 'Error',
  };
}
```

3. Update `_buildErrorView()` to show context-appropriate actions:
```dart
Widget _buildErrorView(String message, ScannerErrorType type, bool isPermanentlyDenied) {
  return Container(
    color: Colors.black87,
    child: Center(
      child: Padding(
        padding: const EdgeInsets.all(32),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Container(
              width: 80,
              height: 80,
              decoration: BoxDecoration(
                color: AppColors.error.withValues(alpha: 0.2),
                borderRadius: BorderRadius.circular(20),
              ),
              child: Icon(
                _getErrorIcon(type),
                size: 40,
                color: AppColors.error,
              ),
            ),
            const SizedBox(height: 24),
            Text(
              _getErrorTitle(type),
              style: GoogleFonts.outfit(
                fontSize: 20,
                fontWeight: FontWeight.w600,
                color: Colors.white,
              ),
            ),
            const SizedBox(height: 8),
            Text(
              message,
              style: GoogleFonts.dmSans(
                fontSize: 14,
                color: Colors.white70,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 24),
            _buildErrorActions(type, isPermanentlyDenied),
          ],
        ),
      ),
    ),
  );
}

IconData _getErrorIcon(ScannerErrorType type) {
  return switch (type) {
    ScannerErrorType.cameraPermission => Icons.no_photography_outlined,
    ScannerErrorType.cameraUnavailable => Icons.videocam_off_outlined,
    ScannerErrorType.markerDetection => Icons.crop_free,
    _ => Icons.error_outline,
  };
}

Widget _buildErrorActions(ScannerErrorType type, bool isPermanentlyDenied) {
  switch (type) {
    case ScannerErrorType.cameraPermission:
      if (isPermanentlyDenied) {
        // Show "Open Settings" button
        return Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            OutlinedButton(
              onPressed: () => Navigator.pop(context),
              style: OutlinedButton.styleFrom(
                foregroundColor: Colors.white70,
                side: const BorderSide(color: Colors.white30),
              ),
              child: const Text('Close'),
            ),
            const SizedBox(width: 12),
            FilledButton.icon(
              onPressed: () => openAppSettings(),
              icon: const Icon(Icons.settings),
              label: const Text('Open Settings'),
              style: FilledButton.styleFrom(
                backgroundColor: AppColors.scanFeature,
              ),
            ),
          ],
        );
      }
      // Not permanently denied - show retry to re-request
      return FilledButton.icon(
        onPressed: () {
          context.read<ScannerBloc>().add(const ScannerRetryRequested());
        },
        icon: const Icon(Icons.refresh),
        label: const Text('Allow Camera'),
        style: FilledButton.styleFrom(
          backgroundColor: AppColors.scanFeature,
        ),
      );

    case ScannerErrorType.cameraUnavailable:
      // Camera not available - only Close action
      return FilledButton(
        onPressed: () => Navigator.pop(context),
        style: FilledButton.styleFrom(
          backgroundColor: AppColors.scanFeature,
        ),
        child: const Text('Close'),
      );

    default:
      // All other errors - show Retry button
      return FilledButton.icon(
        onPressed: () {
          context.read<ScannerBloc>().add(const ScannerRetryRequested());
        },
        icon: const Icon(Icons.refresh),
        label: const Text('Try Again'),
        style: FilledButton.styleFrom(
          backgroundColor: AppColors.scanFeature,
        ),
      );
  }
}
```

4. Update `_buildStateUI()` to pass `isPermanentlyDenied`:
```dart
ScannerError(:final message, :final type, :final isPermanentlyDenied) =>
  _buildErrorView(message, type, isPermanentlyDenied),
```

### 2.5 Improve Error Messages (6.5.4 - 6.5.6)

Update error messages in `ScannerBloc` for user-friendly guidance:

| Error Type | Current Message | Improved Message |
|------------|-----------------|------------------|
| `markerDetection` (OMR) | "OMR processing failed" | "Could not detect all 4 corner markers. Ensure the sheet is fully visible and printed at 100% scale." |
| `markerDetection` (name) | "Markers not found for name region..." | Same as above |
| `omrProcessing` | "Failed to process scan: {e}" | "Could not read answers. Please try again with better lighting." |
| `persistence` | "Failed to save scan: {e}" | "Could not save result. Check device storage and try again." |
| `imageCapture` | "Failed to capture image: {e}" | "Could not capture image. Please try again." |
| `cameraInitialization` | "Failed to initialize camera: {e}" | "Could not start camera. Please try again." |

### 2.6 Update _onErrorOccurred Handler

**File:** `lib/features/omr/presentation/bloc/scanner_bloc.dart`

Pass the `isPermanentlyDenied` flag through:

```dart
Future<void> _onErrorOccurred(
  ScannerErrorOccurred event,
  Emitter<ScannerState> emit,
) async {
  await _cleanup();

  emit(ScannerError(
    message: event.message,
    type: event.type,
    isPermanentlyDenied: event.isPermanentlyDenied,
  ));
}
```

---

## 3. File Changes Summary

| File | Changes |
|------|---------|
| `lib/core/services/camera_service.dart` | Add permission check, custom exceptions |
| `lib/features/omr/presentation/bloc/scanner_state.dart` | Add `isPermanentlyDenied` to ScannerError |
| `lib/features/omr/presentation/bloc/scanner_event.dart` | Add `isPermanentlyDenied` to ScannerErrorOccurred |
| `lib/features/omr/presentation/bloc/scanner_bloc.dart` | Detect permission/unavailable errors, improve messages |
| `lib/features/omr/presentation/pages/scan_papers_page.dart` | Context-appropriate actions, all error titles |

---

## 4. Verification Checklist (6.5.7)

Manual testing steps to verify error handling:

### 4.1 Camera Permission Denied (First Request)
1. Revoke camera permission in device settings
2. Launch app ’ Navigate to Scan Papers
3. Deny permission when prompted
4. **Expected:** "Camera Access Required" title, "Camera access is required..." message, "Allow Camera" button
5. Tap "Allow Camera" ’ permission prompt appears again

### 4.2 Camera Permission Permanently Denied
1. Revoke camera permission in device settings
2. Launch app ’ Navigate to Scan Papers
3. Deny permission with "Don't ask again" (Android) or after 2 denials (iOS)
4. **Expected:** "Camera Access Required" title, "...enable it in Settings..." message, "Open Settings" + "Close" buttons
5. Tap "Open Settings" ’ device settings opens

### 4.3 Camera Unavailable
1. (Simulator only) Remove camera from simulator configuration
2. Launch app ’ Navigate to Scan Papers
3. **Expected:** "Camera Not Available" title, "No camera found..." message, "Close" button only
4. Tap "Close" ’ returns to previous screen

### 4.4 Marker Detection Failed
1. Point camera at blank wall or paper without markers
2. Tap manual capture (if available) or wait for auto-capture timeout
3. **Expected:** "Sheet Not Detected" title, "...all 4 corner markers visible, printed at 100% scale" message, "Try Again" button

### 4.5 Processing Failed
1. (Would need to inject failure) Simulate OMR pipeline error
2. **Expected:** "Processing Error" title, "Could not read answers..." message, "Try Again" button

### 4.6 Storage/Save Failed
1. (Would need to inject failure) Simulate Hive write error
2. **Expected:** "Save Error" title, "Could not save result..." message, "Try Again" button

---

## 5. Dependencies

- `permission_handler: ^12.0.1` - Already in pubspec.yaml, just needs import

---

## 6. Estimated Effort

| Subtask | Effort |
|---------|--------|
| 2.1 CameraService permission check | 15 min |
| 2.2 ScannerBloc error detection | 10 min |
| 2.3 State/Event updates | 10 min |
| 2.4 UI error actions | 20 min |
| 2.5 Error message improvements | 10 min |
| 2.6 Handler update | 5 min |
| Testing & verification | 20 min |
| **Total** | ~90 min |
