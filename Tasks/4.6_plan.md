# Task 4.6: High-Res Capture & Processing - Implementation Plan

## Overview
Wire the high-resolution capture flow to the full OMR pipeline, grading, name-region extraction, and persistence. Ensure robust error handling, correct state transitions, and <500ms processing time on target devices.

## Current Code Audit (v2.3)
- `lib/features/omr/presentation/bloc/scanner_bloc.dart` already contains:
  - Capture trigger in `_onStabilityAchieved` calling `CameraService.captureImage()`.
  - `_onImageCaptured` running `OmrPipeline.process(...)`, `GradingService.grade(...)`, name region extraction, and persistence via `ScanRepository`.
  - Processing status updates (`ScannerProcessing`) and result emission (`ScannerProcessingComplete`).
- `lib/features/omr/services/omr_scanner_service.dart` (`OmrPipeline`) orchestrates preprocess → marker detect → perspective warp → bubble read → threshold → answer extraction.
- `lib/features/omr/services/grading_service.dart` computes score and per-question results.
- `lib/features/omr/services/template_manager.dart` returns `OmrTemplate` by id.
- `lib/features/omr/data/repositories/scan_repository_impl.dart` persists `ScanResultModel` to Hive.
- `lib/features/omr/presentation/pages/scan_papers_page.dart` listens for `ScannerResult` and shows `ScanResultPopup`.

Gaps and risks to verify:
- Ensure processing status updates are consistent and timed correctly.
- Confirm name-region extraction works for all templates and handles missing markers.
- Validate that all `cv.Mat` allocations are disposed on every path.
- Ensure repository failures surface as `ScannerErrorType.persistence` (currently mapped to `omrProcessing`).
- Confirm processing time budget (<500ms) on device.

## Requirements (from Development Plan)
1. On `Capturing` state → call `CameraService.captureImage()`.
2. Feed image to `OmrScannerService.scanAnswerSheet(image, template)` (equivalent to `OmrPipeline.process`).
3. Get `ScanResult` with detected answers + statuses.
4. Call `GradingService.grade(scanResult, answerKey)`.
5. Get `GradedResult` with score.
6. Save to `ScanRepository`.
7. Emit `ProcessingComplete` with result.

## Files to Modify / Verify
| File | Purpose |
|------|---------|
| `lib/features/omr/presentation/bloc/scanner_bloc.dart` | Primary capture + processing orchestration, error mapping, status updates |
| `lib/features/omr/services/omr_scanner_service.dart` | Pipeline processing and performance timing |
| `lib/features/omr/services/grading_service.dart` | Grading logic correctness |
| `lib/features/omr/services/template_manager.dart` | Template loading |
| `lib/features/omr/data/repositories/scan_repository_impl.dart` | Persistence correctness |
| `test/features/omr/presentation/bloc/scanner_bloc_test.dart` | Add success/error flow tests |

## Detailed Implementation Steps

### Step 1: Validate capture flow and state transitions
- Confirm `_onStabilityAchieved`:
  - Cancels frame stream subscription.
  - Stops the preview stream before capture.
  - Emits `ScannerCapturing` then dispatches `ScannerImageCaptured`.
- Ensure errors during capture map to `ScannerErrorType.imageCapture` and invoke cleanup.

### Step 2: Load template and build bubble map
- In `_onImageCaptured`, load `OmrTemplate` via `TemplateManager.getTemplate(quiz.templateId)`.
- Build `bubblePositions` from `template.fieldBlocks` using `bubbleWidth`, `bubbleHeight`, `labelsGap`, and `bubblesGap`.
- Validate that positions are non-empty and within template bounds to avoid ROI errors.

### Step 3: Run OMR pipeline and handle failures
- Call `OmrPipeline.process(imageBytes, templateWidth, templateHeight, bubblePositions)`.
- If `success == false`, emit `ScannerErrorOccurred`:
  - `markerDetection` when markers are missing.
  - `omrProcessing` for other pipeline failures.
- Ensure all `cv.Mat` objects are disposed in `OmrPipeline` and name-region extraction.

### Step 4: Convert answers to domain status + grade
- Convert `threshold_calculator.ExtractedAnswer` → `AnswerStatus` domain entity.
- Call `GradingService.grade(extractedAnswers, answerKey)`.
- Ensure answer key length and extracted answers align; guard missing questions as blanks.

### Step 5: Extract name region image
- Decode captured image with `ImagePreprocessor.decodeImage`.
- Detect markers and compute corner points for transform.
- Warp perspective and crop `template.nameRegion`.
- Encode to PNG and return `Uint8List`.
- If markers are missing, return a user-facing error (`ScannerErrorType.markerDetection`).

### Step 6: Build and persist `ScanResult`
- Construct `ScanResult` with:
  - `id`, `quizId`, `scannedAt`, `detectedAnswers`, `score`, `total`, `percentage`, `scanConfidence`, `nameRegionImage`.
- Persist via `ScanRepository.save(...)`.
- If persistence fails, emit `ScannerErrorType.persistence`.

### Step 7: Emit result and restart flow
- Emit `ScannerProcessingComplete` with `processingTimeMs` from pipeline.
- UI shows `ScanResultPopup` and awaits user action.
- On `ResultDismissed`, restart the stream and return to `ScannerPreviewing`.

### Step 8: Performance validation
- Ensure end-to-end processing time is <500ms on target devices.
- If not, consider:
  - Reducing image resolution for processing (while keeping capture high-res).
  - Moving heavy operations into an isolate using `compute()` if CPU-bound.

## Testing Plan

### BLoC Tests
Extend `test/features/omr/presentation/bloc/scanner_bloc_test.dart`:
- Success path: simulate `ScannerImageCaptured` and mock pipeline + grading + repository to return a valid result, expect `ScannerProcessing` → `ScannerResult`.
- Failure path: pipeline returns `success=false` and emit `ScannerError` with correct type.
- Persistence failure: repository throws, expect `ScannerErrorType.persistence`.

### Service Tests (optional)
- Use `omr_spike` assets to validate `OmrPipeline.process` output for at least one template.
- Add tests for `ImagePreprocessor` and `MarkerDetector` edge cases if needed.

## Done When
- High-res capture triggers OMR processing without UI blocking.
- Results are graded, persisted, and displayed.
- Errors are mapped to correct `ScannerErrorType`.
- Processing time is <500ms on a representative device.
