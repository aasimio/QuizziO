# Task 6.5: Error Handling — Execution Plan (Codex)

> Scope note: This is a **plan only** (no implementation yet). It prepares Task **6.5** from `Tasks/Development-Plan-v2_3.md`.
>
> References:
> - `Tasks/Development-Plan-v2_3.md` → Task **6.5 Error Handling**
> - `Tasks/PRD.md` → Appendix C (Scanner state machine + error-state table)
> - `CLAUDE.md` → architecture + BLoC rules (Clean Architecture, `isClosed` checks, Equatable states)

## 1) Goal / Definition of Done

Task 6.5 is complete when **every scanner error path** renders a **user-friendly** error screen with the **correct actions**, specifically:

- **Camera permission denied** → message + **Open Settings** (`openAppSettings()`)
- **Camera unavailable** → “Camera not available” + **Close**
- **Marker detection failed** → “Ensure all 4 corner markers visible, printed at 100% scale” + **Retry**
- **Processing failed** → “Could not read answers. Try again.” + **Retry**
- **Storage/save failed** → “Could not save. Check storage.”
- Manual verification: each error is triggered and UI/actions confirm (Task 6.5.7)

## 2) Requirements (from Dev Plan + PRD)

### 2.1 Development-Plan v2.3 (Task 6.5)
From `Tasks/Development-Plan-v2_3.md`:
- 6.5.1 Audit existing error handling (ScannerBloc error types + current UI)
- 6.5.2 Permission denied → Open Settings (`openAppSettings()`)
- 6.5.3 Camera unavailable → Close
- 6.5.4 Marker detection failed → Retry + specific copy
- 6.5.5 Processing failed → Retry + specific copy
- 6.5.6 Save failed → specific copy
- 6.5.7 Verify error UI by manually triggering each error type

### 2.2 PRD Appendix C (Scanner State Machine)
`Tasks/PRD.md` Appendix C describes an **ERROR** state with:
- user-friendly message
- retry + dismiss/close actions
- error-type table including camera permission/unavailable, detection failed, processing failed, unknown error

We’ll treat the Dev Plan copy/action requirements as the “locked” spec for 6.5, and align with PRD where it doesn’t conflict (e.g., still offering Close where helpful).

## 3) Current State Audit (6.5.1)

### 3.1 Current error taxonomy (existing)
`lib/features/omr/presentation/bloc/scanner_state.dart`:
- `ScannerErrorType.cameraInitialization`
- `ScannerErrorType.markerDetection`
- `ScannerErrorType.imageCapture`
- `ScannerErrorType.omrProcessing`
- `ScannerErrorType.grading`
- `ScannerErrorType.persistence`

### 3.2 Current error rendering (existing)
`lib/features/omr/presentation/pages/scan_papers_page.dart`:
- Error screen shows title based on `ScannerErrorType`
- Message is whatever the BLoC emits (often includes exception strings)
- Always shows a single CTA: **Try Again** → dispatches `ScannerRetryRequested()`
- No **Close** action, no **Open Settings**

### 3.3 Key gaps vs Task 6.5
- No explicit “permission denied” error type/action.
- No explicit “camera unavailable” error type/action.
- Marker detection and processing errors currently may display **technical** copy from pipeline exceptions/results.
- Persistence error copy currently includes exception details (not user-friendly).

## 4) Target Behavior (UX + Error Model)

### 4.1 Proposed error categories (scanner-specific)
Add/adjust scanner error types to map cleanly to Task 6.5:

- `cameraPermissionDenied` (new)
- `cameraUnavailable` (new)
- Keep existing: `markerDetection`, `omrProcessing`, `persistence`, `imageCapture`
- Keep `cameraInitialization` for “other camera init” failures that aren’t permission/unavailable (fallback)
- Treat `grading` as rare; map it to “Processing failed” UI (or a dedicated title if desired)

### 4.2 UX copy + actions matrix (what the user sees)

| Category | Title | Message (locked copy) | Primary action | Secondary action |
|---|---|---|---|---|
| Permission denied | Camera Permission | Camera permission is needed to scan papers. | Open Settings (`openAppSettings()`) | Close |
| Camera unavailable | Camera Not Available | Camera not available. | Close | (optional) Try Again |
| Marker detection failed | Markers Not Found | Ensure all 4 corner markers are visible and the sheet is printed at 100% scale. | Retry | Close |
| Processing failed | Processing Error | Could not read answers. Try again. | Retry | Close |
| Save failed | Save Error | Could not save. Check storage. | Retry (re-scan) or Close | Close |
| Capture failed (existing) | Capture Failed | Couldn’t capture a photo. Try again. | Retry | Close |
| Unknown fallback | Something Went Wrong | Something went wrong. Please try again. | Retry | Close |

Notes:
- Dev Plan only mandates specific copy for 6.5.3–6.5.6; the remaining copy can be tuned, but keep it short and non-technical.
- We should **log** the technical exception (debug/dev reminder) but not surface it in the UI message.

## 5) Implementation Plan (mapped to 6.5.x)

### 5.1 (6.5.1) Audit + map all error sources
Deliverable: a short mapping list (for the PR/implementation notes) that enumerates:
- where errors originate (`CameraService.initialize`, `captureImage`, `OmrPipeline.process`, name-region extraction, Hive save)
- which `ScannerErrorType` should be emitted
- what UI copy/action should show

### 5.2 (6.5.2) Camera permission denied → Open Settings
Goal: reliably detect permission denial and emit `cameraPermissionDenied`.

Implementation approach (recommended):
1. In `ScannerBloc._onInitCamera`, check/request camera permission via `permission_handler`.
2. If permission not granted:
   - emit `ScannerError(type: cameraPermissionDenied, message: <friendly copy>)`
3. The error UI shows **Open Settings** button calling `openAppSettings()`.

Details to confirm during implementation:
- Use `Permission.camera.status` / `.request()` and handle `denied`, `permanentlyDenied`, `restricted` (iOS), `limited` (if applicable).
- Don’t block the UI; emit error quickly.
- Avoid repeated permission prompts: if request returns denied, move to error state; user can retry after settings.

Files likely touched:
- `lib/features/omr/presentation/bloc/scanner_state.dart` (new enum value)
- `lib/features/omr/presentation/bloc/scanner_bloc.dart` (permission gating + error emission)
- `lib/features/omr/presentation/pages/scan_papers_page.dart` (Open Settings button)

### 5.3 (6.5.3) Camera unavailable → Close
Goal: distinguish “permission denied” from “camera unavailable” and provide Close-only UX.

Implementation tasks:
- Update `CameraService.initialize()` to preserve underlying `CameraException` codes instead of wrapping everything as `initializationFailed` (so we can distinguish):
  - no cameras present
  - camera in use / access restricted
  - other init failures
- In `ScannerBloc._onInitCamera`:
  - map “no camera / unavailable / in use” to `cameraUnavailable`
  - map “everything else” to `cameraInitialization` fallback

UI action:
- **Close** pops the scan page (`Navigator.pop`), returning the user to quiz menu.

Files likely touched:
- `lib/core/services/camera_service.dart` (exception preservation)
- `lib/features/omr/presentation/bloc/scanner_bloc.dart` (exception classification)
- `lib/features/omr/presentation/pages/scan_papers_page.dart` (Close CTA)

### 5.4 (6.5.4) Marker detection failed → Retry + locked copy
Error sources (current):
- `OmrPipeline.process()` returns `success=false` with `markerResult.allMarkersFound == false`
- Name-region extraction throws `_MarkerExtractionException` (markers not found / corners missing)

Implementation tasks:
- Ensure `ScannerBloc` uses **standardized UI copy** for `markerDetection`:
  - Do not pass through technical messages like “Found 2/4 markers…”
- Keep technical details in logs only.

UI action:
- Retry calls `ScannerRetryRequested()` (re-initialize and restart preview).

Files likely touched:
- `lib/features/omr/presentation/bloc/scanner_bloc.dart`
- `lib/features/omr/presentation/pages/scan_papers_page.dart`

### 5.5 (6.5.5) Processing failed → Retry + locked copy
Error sources (current):
- `OmrPipeline.process()` generic failure
- template load failures
- name region extraction non-marker errors
- unexpected exceptions in processing pipeline

Implementation tasks:
- Standardize UI message for `omrProcessing` to the locked copy:
  - “Could not read answers. Try again.”
- Keep “unknown error” fallback consistent.

UI action:
- Retry calls `ScannerRetryRequested()`.

### 5.6 (6.5.6) Storage/save failed → locked copy
Error source:
- Hive `_box.put(...)` (disk full, corruption, adapter issues, permission problems on platform storage)

Implementation tasks:
- Standardize persistence UI message to:
  - “Could not save. Check storage.”
- Decide UX for primary CTA:
  - simplest: show **Close** + (optional) “Try Again” (re-scan)
  - avoid claiming a “save retry” unless we actually re-attempt save without forcing a rescan

### 5.7 Error UI componentization (recommended for clarity + tests)
To keep `ScanPapersPage` lean and make widget testing feasible, extract error UI to a dedicated widget, e.g.:
- `lib/features/omr/presentation/widgets/scanner_error_view.dart`

Responsibilities:
- render title/message/icon
- render buttons based on `ScannerErrorType`
- expose callbacks for `onRetry`, `onClose`, `onOpenSettings`

This is optional but reduces coupling and makes 6.5.7 verification easier.

### 5.8 (6.5.7) Verification plan (manual triggers + checklist)
Manual verification should be performed on at least one Android device and one iOS device (if available).

#### Trigger matrix
- Permission denied:
  - Remove camera permission in OS settings → open ScanPapersPage → verify “Open Settings” shows
  - Tap Open Settings → grant permission → return → tap Retry/Try Again → preview starts
- Camera unavailable:
  - Run on an emulator/simulator without a camera, OR keep camera occupied by another app/session (best-effort)
  - Verify “Camera not available” + Close returns to previous screen
- Marker detection failed:
  - Cover/occlude any corner marker, or use a sheet without ArUco markers
  - Force capture (manual capture) to reach pipeline and confirm marker-detection error copy + Retry
- Processing failed:
  - Use an intentionally bad capture (extreme blur, low light, wrong template if possible)
  - Confirm processing error copy + Retry returns to preview
- Save failed:
  - Best-effort: simulate low storage (fill device) OR (preferred for deterministic QA) add a temporary debug flag in repository to throw (only during dev verification)
  - Confirm save error copy and actions

#### UI/action checklist
- Correct title per error type
- Message matches locked copy
- Primary CTA matches expected behavior (Retry/Open Settings/Close)
- Close always exits scanner cleanly (no stuck preview overlay)

## 6) Acceptance Criteria (implementation-ready)
- 6.5.2: Permission denied shows Open Settings (and does not show raw exception text)
- 6.5.3: Camera unavailable shows Close
- 6.5.4: Marker detection failure shows locked copy + Retry
- 6.5.5: Processing failure shows locked copy + Retry
- 6.5.6: Save failure shows locked copy (and does not show raw exception text)
- 6.5.7: Each case manually verified on-device (document device + OS + steps)

## 7) Risks / Edge Cases
- Camera plugin exceptions vary by platform; mitigate by using `permission_handler` as the primary permission signal.
- Returning from OS Settings does not automatically re-init camera; mitigate by providing Retry, and optionally re-init on app resume if state is permission error.
- If camera controller is kept alive across pages (singleton), ensure Close doesn’t leave the camera in a locked/busy state; validate during manual testing.

## 8) Deliverables
- Code changes implementing Task 6.5 (files listed above)
- Short QA note (in PR description or a `Tasks/6.5_verification.md` log) documenting the 6.5.7 manual trigger results

