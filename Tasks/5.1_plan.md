# Task 5.1: GradedPapersBloc - Implementation Plan

## Overview
Implement the results-management BLoC that loads graded scan results per quiz, supports manual corrections (score recalculation), and handles deletion. Align with existing BLoC patterns, keep state immutable, and ensure persistence via `ScanRepository`.

## Current Code Audit (v2.3)
- `lib/features/omr/domain/entities/scan_result.dart` stores `detectedAnswers` (`Map<String, AnswerStatus>`), `correctedAnswers` (`Map<String, String?>`), and scoring fields (`score`, `total`, `percentage`, `wasEdited`).
- `lib/features/omr/data/models/scan_result_model.dart` persists detected answers using `detectedAnswerValues` + `answerStatuses`; corrected answers are stored as `Map<String, String?>`.
- `lib/features/omr/domain/repositories/scan_repository.dart` exposes `getByQuizId`, `getById`, `save`, `update`, `delete`.
- `lib/features/omr/services/grading_service.dart` grades from `Map<String, AnswerStatus>` + answer key, returns `GradedResult` with `score` and `percentage` (0-100 scale).
- `lib/features/omr/presentation/pages/graded_papers_page.dart` is a placeholder; no BLoC exists yet.
- `lib/features/quiz/presentation/pages/quiz_menu_page.dart` navigates to graded papers with only `quizId` and `quizName` (no answer key).

## Requirements (from Development Plan)
1. Events: `LoadResults`, `UpdateResult`, `DeleteResult`.
2. States: `ResultsInitial`, `ResultsLoading`, `ResultsLoaded`, `ResultsError`.
3. Inject `ScanRepository`.
4. `LoadResults` fetches by quiz ID and sorts by date.
5. `UpdateResult` updates corrected answers, recalculates score, saves.
6. `DeleteResult` removes result from repository.
7. Register in DI and ensure BLoC tests pass.

## MVP Decisions (Locked)
- **Answer key access:** Always load the current answer key from `QuizRepository` using `result.quizId`. The UI does not pass keys around.
- **Manual "multiple mark" representation:** Keep `correctedAnswers` as `Map<String, String?>` and use a sentinel string (`'MULTIPLE_MARK'`) for multi-mark overrides; `null` means blank; `"A"-"E"` means valid.
- **Schema impact:** No Hive schema change for MVP; avoid adding `correctedAnswerStatuses` until after MVP.
- **Percentage scale:** `GradedResult.percentage` is 0-100 and must remain consistent when updating results.

## Files to Create / Modify
| File | Purpose |
| --- | --- |
| `lib/features/omr/presentation/bloc/graded_papers_bloc.dart` | BLoC implementation for results list CRUD |
| `lib/features/omr/presentation/bloc/graded_papers_event.dart` | Event definitions |
| `lib/features/omr/presentation/bloc/graded_papers_state.dart` | State definitions |
| `lib/injection.config.dart` | Generated DI config (via build_runner) |
| `test/features/omr/presentation/bloc/graded_papers_bloc_test.dart` | BLoC unit tests |

## Detailed Implementation Steps

### Step 1: Define events and states
- Create `GradedPapersEvent` sealed class with:
  - `LoadResults({required String quizId})`
  - `UpdateResult({required ScanResult result, required Map<String, String?> correctedAnswers})`
  - `DeleteResult({required String resultId})`
- Create `GradedPapersState` sealed class with:
  - `ResultsInitial`
  - `ResultsLoading`
  - `ResultsLoaded({required String quizId, required List<ScanResult> results})`
  - `ResultsError({required String message})`
- Ensure all states/events extend `Equatable` and include full `props`.

### Step 2: Implement `GradedPapersBloc`
- Add `@injectable` and inject dependencies:
  - `ScanRepository`
  - `QuizRepository` (to fetch answer key by `quizId`)
  - `GradingService`
- Register event handlers with `on<LoadResults>`, `on<UpdateResult>`, `on<DeleteResult>`.
- Follow existing pattern: emit loading state, perform repo work, check `isClosed` before emitting after awaits.

### Step 3: `LoadResults` handler
- Call `ScanRepository.getByQuizId(quizId)`.
- Sort results by `scannedAt` descending.
- Emit `ResultsLoaded(quizId: quizId, results: sortedResults)`.
- On error, emit `ResultsError('Failed to load results: ...')`.

### Step 4: `UpdateResult` handler (corrections + grading)
- Build a new corrected map (copy to avoid mutation), then load the quiz:
  - `final quiz = await _quizRepository.getById(result.quizId)` and guard `quiz == null`.
- Create effective answers:
  - Start with `Map<String, AnswerStatus>` from `result.detectedAnswers`.
  - Override entries found in `correctedAnswers`:
    - `null` -> `AnswerStatus.blank()`
    - sentinel `"MULTIPLE_MARK"` -> `AnswerStatus.multipleMark()`
    - `"A"-"E"` -> `AnswerStatus.valid(value)`
- Call `GradingService.grade(extractedAnswers: effectiveAnswers, answerKey: quiz.answerKey)` to get `GradedResult`.
- Create updated `ScanResult` using `copyWith`:
  - `correctedAnswers: updatedCorrectedAnswers`
  - `wasEdited: updatedCorrectedAnswers.isNotEmpty`
  - `score`, `total`, `percentage` from `GradedResult`
- Persist via `ScanRepository.update(updatedResult)`.
- Update in-memory list if state is `ResultsLoaded`:
  - Replace the matching item by `id`, then re-sort by `scannedAt`.
  - Otherwise, reload by `quizId`.
- On error, emit `ResultsError('Failed to update result: ...')` and optionally re-emit previous `ResultsLoaded` (same pattern as `QuizBloc`).

### Step 5: `DeleteResult` handler
- Call `ScanRepository.delete(resultId)`.
- If state is `ResultsLoaded`, remove the result from list and emit updated `ResultsLoaded`.
- If not loaded, optionally re-fetch with `quizId` (if tracked).
- On error, emit `ResultsError('Failed to delete result: ...')` and optionally restore previous state.

### Step 6: Helpers and guardrails
- Add private helpers for sorting and effective-answer mapping to keep handlers readable.
- Keep all state updates immutable; do not mutate existing lists/maps.
- Always `if (isClosed) return;` after awaits.

### Step 7: DI + build_runner
- Ensure the new bloc is registered via `@injectable`.
- Run `dart run build_runner build --delete-conflicting-outputs` to update `lib/injection.config.dart`.

## Testing Plan

### Unit / BLoC tests (`graded_papers_bloc_test.dart`)
- **Initial state**: `ResultsInitial`.
- **LoadResults success**: returns sorted list by `scannedAt`.
- **LoadResults error**: emits `ResultsError`.
- **UpdateResult success**:
  - Uses corrected answers to recompute score.
  - Loads answer key from `QuizRepository`.
  - Calls `ScanRepository.update` with updated entity.
  - Emits updated `ResultsLoaded` with replaced item.
- **UpdateResult error**: emits `ResultsError` and restores previous loaded state.
- **DeleteResult success**: repository delete called, item removed from list.
- **DeleteResult error**: emits `ResultsError`.
- Add a small test for the corrected-answer mapping (blank vs multiple mark vs valid) using the sentinel string.

## Done When
- `GradedPapersBloc` loads, updates, and deletes results correctly with sorted output.
- Manual corrections recalculate score and persist updates.
- DI registration compiles and BLoC tests pass.
